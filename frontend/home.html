<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link
      href="https://cdn.rawgit.com/harvesthq/chosen/gh-pages/chosen.min.css"
      rel="stylesheet"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdn.rawgit.com/harvesthq/chosen/gh-pages/chosen.jquery.min.js"></script>
    <link href="./../style/style.css" rel="stylesheet" />
    <title>Home</title>
  </head>
  <body class="bg-pink-50 min-h-screen">
    <header
      class="dating-header flex bg-pink-500 text-white p-4 justify-between items-center shadow-lg"
    >
      <h1 class="text-2xl font-bold tracking-wide">
        <a href="/" class="hover:text-pink-200 transition">💖 Dating App</a>
      </h1>
      <nav class="bg-pink-500 p-4 flex items-center relative">
        <div class="flex-1"></div>
        <!-- Desktop menu -->
        <ul class="hidden md:flex space-x-4">
          <li>
            <button
              class="dating-button text-white border-2 border-white p-2 px-5 rounded-xl bg-red-500 hover:bg-red-600 transition"
              id="logout-btn"
              onclick="handleLogout()"
            >
              Logout
            </button>
          </li>
        </ul>
        <!-- Hamburger Button (Mobile Only) -->
        <button
          id="menu-btn"
          class="md:hidden flex items-center text-white text-3xl focus:outline-none ml-2 z-50"
        >
          <svg
            class="w-8 h-8"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M4 6h16M4 12h16M4 18h16"
            />
          </svg>
        </button>
        <!-- Mobile Menu -->
        <div
          id="mobile-menu"
          class="fixed top-0 right-0 h-full w-64 bg-white shadow-lg z-40 flex flex-col gap-4 p-8 transform translate-x-full transition-transform duration-300 md:hidden"
        >
          <p><strong class="text-pink-500 text-2xl">Main Menu</strong><br /></p>
          <button
            class="dating-button text-pink-500 border-2 border-pink-500 p-2 px-5 rounded-xl bg-white hover:bg-pink-100 transition"
            onclick="handleLogout()"
          >
            Logout
          </button>
        </div>
      </nav>
    </header>

    <main
      class="dating-container max-w-md mx-auto mt-8 p-8 bg-white shadow-2xl rounded-3xl border border-pink-200 mb-12"
    >
      <div class="flex flex-col items-center mb-8">
        <div class="text-5xl mb-2">💖</div>
        <h2 class="text-2xl font-bold text-pink-600 mb-1">
          Tell us about your <span class="text-pink-400">Hobbies</span>
        </h2>
        <p class="text-md text-pink-400 mb-2 text-center">
          Select your hobbies below so we can match you with like-minded people!
        </p>
      </div>

      <form class="space-y-6">
        <div class="mb-6">
          <label class="block text-pink-700 font-bold mb-3 text-lg" for="hobby">
            Your Hobbies
          </label>
          <select
            id="hobby"
            name="hobby"
            class="chosen-select w-full"
            multiple
            data-placeholder="Choose your hobbies..."
          >
            <option value="reading">📚 Reading</option>
            <option value="sports">🏀 Sports</option>
            <option value="music">🎵 Music</option>
            <option value="traveling">🌍 Traveling</option>
            <option value="cooking">🍳 Cooking</option>
            <option value="gaming">🎮 Gaming</option>
            <option value="art">🎨 Art</option>
            <option value="photography">📷 Photography</option>
            <option value="movies">🎬 Movies</option>
            <option value="dancing">💃 Dancing</option>
          </select>
          <p class="text-xs text-pink-400 mt-2">
            Click to select multiple hobbies!
          </p>
        </div>

        <div class="mb-6">
          <label
            class="block text-pink-700 font-bold mb-3 text-lg"
            for="interest"
          >
            Your Interests
          </label>
          <select
            id="interest"
            name="interest"
            class="chosen-select w-full"
            multiple
            data-placeholder="Choose your interests..."
          >
            <option value="technology">💻 Technology</option>
            <option value="fashion">👗 Fashion</option>
            <option value="science">🔬 Science</option>
            <option value="nature">🌱 Nature</option>
            <option value="movies">🎬 Movies</option>
            <option value="food">🍔 Food</option>
            <option value="sports">🏆 Sports</option>
            <option value="travel">✈️ Travel</option>
            <option value="photography">📸 Photography</option>
            <option value="music">🎶 Music</option>
          </select>
          <p class="text-xs text-pink-400 mt-2">
            Click to select multiple interests!
          </p>
        </div>

        <button
          type="button"
          id="save-btn"
          class="dating-button w-full bg-pink-500 hover:bg-pink-600 transition font-bold py-3 rounded-xl text-white text-lg shadow-lg flex justify-center items-center"
          onclick="handleSave()"
        >
          <span class="mr-2">Save</span>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M5 12h14M12 5l7 7-7 7"
            />
          </svg>
        </button>
      </form>
    </main>

    <footer class="bg-pink-500 text-white mt-auto p-6 text-center">
      <p>&copy; 2025 Dating App. All rights reserved.</p>
    </footer>

    <script>
      // Hamburger menu toggle
      const menuBtn = document.getElementById("menu-btn");
      const mobileMenu = document.getElementById("mobile-menu");

      menuBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        mobileMenu.classList.toggle("translate-x-full");
      });

      // Close menu when clicking outside
      document.addEventListener("click", function (event) {
        if (
          !menuBtn.contains(event.target) &&
          !mobileMenu.contains(event.target)
        ) {
          mobileMenu.classList.add("translate-x-full");
        }
      });

      // Close menu when resize to desktop
      window.addEventListener("resize", () => {
        if (window.innerWidth >= 768) {
          mobileMenu.classList.add("translate-x-full");
        }
      });

      // For the Chosen plugin
      $(function () {
        $(".chosen-select").chosen({
          no_results_text: "Oops, nothing found!",
          width: "100%",
        });

        // Load data yang sudah tersimpan untuk pre-select
        fetchUserSavedData();
      });

      // Function handle save hobbies and interests
      function handleSave() {
          const hobby = document.getElementById("hobby");
          const interest = document.getElementById("interest");
          const saveBtn = document.getElementById("save-btn");

          const selectedHobbies = Array.from(hobby.selectedOptions).map(
              (opt) => opt.value
          );
          const selectedInterests = Array.from(interest.selectedOptions).map(
              (opt) => opt.value
          );
          console.log(selectedHobbies)

          // Validation: Check if user selected at least one hobby or interest
          if (selectedHobbies.length === 0 && selectedInterests.length === 0) {
              alert("Please select at least one hobby or interest!");
              return;
          }

          // Disable button dan show loading
          saveBtn.disabled = true;
          saveBtn.innerHTML = '<span class="mr-2">Saving...</span>';

          fetch("/api/p/user-edit", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(
                  {
                      hobbies: selectedHobbies,
                      interests: selectedInterests,
                  }
              ),
          }).then((response) => {
              if (response.status == 200) {
                  window.location.href = "/p/result";
              } else {
                  throw new Error("Failed to save the new user data.");
              }
          }).catch((error) => {
              alert("An error occurred while saving. Please try again.");

              // Reset button
              saveBtn.disabled = false;
              saveBtn.innerHTML = `
              <span class="mr-2">Save</span>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7" />
              </svg>
            `;
          });
      }

      // Fetch data yang sudah user simpan sebelumnya
      async function fetchUserSavedData() {
          try {
              const response = await fetch("/api/p/user-info", {
                  method: "GET",
                  headers: {
                      "Content-Type": "application/json",
                  },
              });

              if (!response.ok) {
                  console.error("Failed to fetch:", response.status);
                  return;
              }

              const data = await response.json();

              const hobbySelect = document.getElementById("hobby");
              const interestSelect = document.getElementById("interest");

              if (Array.isArray(data.data.Hobbies)) {
                  data.data.Hobbies.forEach((item) => {
                      const savedHobbyName = item.Name || "";
                      const option = hobbySelect.querySelector(
                          `option[value="${savedHobbyName}"]`
                      );
                      if (option) option.selected = true;
                  });
                  $("#hobby").trigger("chosen:updated");
              }

              if (Array.isArray(data.data.Interests)) {
                  data.data.Interests.forEach((item) => {
                      const savedInterestName = item.Name || "";
                      const option = interestSelect.querySelector(
                          `option[value="${savedInterestName}"]`
                      );
                      if (option) option.selected = true;
                  });
                  $("#interest").trigger("chosen:updated");
              }
          } catch (error) {
              console.error("Error fetching user hobbies:", error);
          }
      }


      // API logout
      function handleLogout() {
        fetch("/api/p/user-logout", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => {
            if (response.status === 200) {
              window.location.href = "/login";
            } else {
              alert("Logout failed. Please try again.");
            }
          })
          .catch((error) => {
            console.error("Logout error:", error);
            alert("An error occurred during logout. Please try again.");
          });
      }
    </script>
  </body>
</html>
